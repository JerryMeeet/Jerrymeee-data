## sonic-agent部署文档

致敬开源官方：https://sonic-cloud.cn/

官方部署文档：https://sonic-cloud.cn/deploy/agent-deploy.html

**将agent代码编译成jar包后，agent分2种部署方式：**

### 1.jar包部署(不推荐，虽然修改方便，但是环境依赖比较多)

##### 1.1. Linux安装jdk15的环境

jdk15需要去亚马逊的网站上下载

##### 1.2. 安装mysql

mysql安装5.7或者8.0以上的版本都是可以的

安装成功以后，需要创建一个数据库,指定字符集

```mysql
# mysql命令
create database sonic default character set utf8 collate utf8_general_ci;
```

##### 1.3 安装ANDROID_HOME

因为运行jar包需要检测是否有安卓环境，所以Linux需要配置安卓到系统PATH中

流程比较复杂，可以参考外部文档

```http
https://blog.csdn.net/ss810540895/article/details/127110603
```

##### 1.4 导入jar包的配置文件

jar包运行外部还需要一些配置文件，其中外部挂载的`application-sonic-agent.yml`配置文件就是其中之一

源码结构如图所示

![image-20230809105628809](C:\Users\79353\AppData\Roaming\Typora\typora-user-images\image-20230809105628809.png)

###### 在linux的结构如图所示

![image-20230809110109350](C:\Users\79353\AppData\Roaming\Typora\typora-user-images\image-20230809110109350.png)

##### 1.5 修改config/application-sonic-agent.yml的配置文件，保存

如图所示

![image-20230809110550388](C:\Users\79353\AppData\Roaming\Typora\typora-user-images\image-20230809110550388.png)

##### 1.6 在工作目录 的路径下执行以下命令

```javascript
java -Dfile.encoding=utf-8 -jar sonic-agent-xxxx.jar
```

### 2.Docker 部署

该方式将一次性部署 Agent 端以及所需环境(推荐，有小bug,后面再解释)

前提：该方式只能是Ubuntu部署，Centos禁用

##### 2.1 参照jar包部署方式安装mysql

部署server以后，登录前端界面，在【设备中心】的【Agent 中心】新增 Agent，记录 Agent 的 Key。

也可以自己写一个key，填入1.2创建的数据库中的agent的表中

![image-20230809141617836](C:\Users\79353\AppData\Roaming\Typora\typora-user-images\image-20230809141617836.png)

##### 2.2 做一个docker-compose.yml文件

复制下面内容，生成一个docker-compose文件，根据描述修改信息

```dockerfile
version: '3'
services:
  sonic-agent:
    image: "sonicorg/sonic-agent-linux:v2.6.1"
    environment:
      # Change to SONIC_SERVER_HOST and SONIC_SERVER_PORT of server | 改成server的SONIC_SERVER_HOST和SONIC_SERVER_PORT
      - SONIC_SERVER_HOST=192.168.1.1
      - SONIC_SERVER_PORT=3000
      # Replace with ipv4 of the agent machine | 替换为部署Agent机器的ipv4
      - AGENT_HOST=192.168.1.1
      # Replace with the port of the agent service, which can be changed by yourself | 替换为Agent服务的端口，可以自行更改
      - AGENT_PORT=7777
      # Replace with the key of agent generated by the new front-end | 替换为前端新增Agent生成的key
      - AGENT_KEY=29002272-4659-4808-a804-08ce3388b136
      # Replace with the bundleId of wda. If there is no. xcrunner suffix, it will be automatically completed. | 替换为wda的bundleId，如果没有.xctrunner后缀会自动补全
      - WDA_BUNDLE_ID=com.facebook.WebDriverAgentRunner.xctrunner
    network_mode: "host"
    privileged: true
    volumes:
      - /dev/bus/usb:/dev/bus/usb
      - /var/run/usbmuxd:/var/run/usbmuxd
```

##### 2.3 执行命令拉取官方镜像启动

```html
docker-compose up -d
```

##### 2.4 替换容器jar包

运行的容器是官方的镜像，并非我们二次开发的代码，所以把我们开发的代码编译成jar包，替换掉原有的jar包

##### 2.4.1 如何替换？

`docker exec .... bash` 进入容器，找到jar包的位置，然后`docker cp` 将我们的jar包替换掉里面的，或者其他替换办法

##### 2.4.2 为什么不直接做镜像？

dockerfile做的镜像启动报错，具体问题暂时不知道在哪，但是可以肯定的是，dockerfile是可以行的通的，但与替换jar包相比，jar包显然更简单，虽然显得另类，但是能抓到老鼠的猫就是好猫。

##### 2.5 容器运行的bug

**问题**：源码是二次开发，yml添加了一些配置，在IDEA开发环境是可以的，但是部署到docker里面，失效了

**原因**：从2.7给出的dockerfile可以看出，config目录下的yml配置文件打包进了镜像，部署只是替换了jar包，但是yml还是以前的，所以在运行环境是失效的

**解决办法**：可以将这个config文件夹挂载出来，或者把config和jar包所在的文件夹都挂载出来，下次更新，也不用再去替换jar包，直接在挂载出来的目录下换就行。理论上是可行的，但是目前还没有实际测过，如果再次开启项目，可以这样试一下。

##### 2.6 agent基础镜像

```dockerfile
FROM ubuntu:jammy-20221130

ENV DEBIAN_FRONTEND=noninteractive

ENV SDK_VERSION=commandlinetools-linux-7583922_latest

WORKDIR /root

RUN apt-get -qqy update && \
    apt-get -qqy --no-install-recommends install \
    ca-certificates \
    usbmuxd \
    zip \
    unzip \
    curl \
    wget \
    libqt5webkit5 \
    libgconf-2-4 \
    gnupg \
    salt-minion \
    libasound2-dev freeglut3-dev libgtk2.0-dev libusb-dev zlib1g libffi-dev libnss3 libbz2-dev zlib1g-dev \
  && rm -rf /var/lib/apt/lists/* \
  && apt-get clean

RUN wget -O java.tar.gz https://github.com/AdoptOpenJDK/openjdk17-binaries/releases/download/jdk-2021-05-07-13-31/OpenJDK-jdk_x64_linux_hotspot_2021-05-06-23-30.tar.gz && \
    tar zxvf java.tar.gz && rm java.tar.gz && \
    chmod a+x -R /root/jdk-17+20 && \
    chown -R root:root /root/jdk-17+20

ENV JAVA_HOME="/root/jdk-17+20" \
    PATH=$PATH:$JAVA_HOME/bin

ENV ANDROID_HOME=/root

RUN mkdir -p $ANDROID_HOME/cmdline-tools && \
    cd $ANDROID_HOME/cmdline-tools && \
    wget -O tools.zip https://dl.google.com/android/repository/${SDK_VERSION}.zip && \
    unzip tools.zip && rm tools.zip && \
    mv ./* ./latest && \
    chmod a+x -R $ANDROID_HOME && \
    chown -R root:root $ANDROID_HOME

ENV PATH=$PATH:$ANDROID_HOME/cmdline-tools/latest:$ANDROID_HOME/cmdline-tools/latest/bin

RUN mkdir -p ~/.android && \
    touch ~/.android/repositories.cfg && \
    echo y | sdkmanager "platform-tools"

ENV PATH=$PATH:$ANDROID_HOME/platform-tools

RUN adb devices && mkdir -p mini plugins config
```

##### 2.7 agent 镜像

```dockerfile
FROM sonicorg/sonic-agent-linux-base:v1.0.1

ADD /mini /root/mini
ADD /plugins /root/plugins
ADD /src/main/docker/config /root/config
ADD /target/sonic-agent-linux-x86_64.jar /root
RUN ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime
ENTRYPOINT ["/root/jdk-15.0.2+7/bin/java","-server","-Dfile.encoding=utf-8","-XX:-UseGCOverheadLimit","-XX:+DisableExplicitGC","-XX:SurvivorRatio=1","-XX:LargePageSizeInBytes=128M","-XX:SoftRefLRUPolicyMSPerMB=0","-Djava.security.egd=file:/dev/./urandom","--add-exports=java.naming/com.sun.jndi.ldap=ALL-UNNAMED","-jar","sonic-agent-linux-x86_64.jar"]
```

